<html>
<head>
<meta charset="utf-8"/>
<link rel="stylesheet" href="http://openlayers.org/en/v3.3.0/css/ol.css" type="text/css">
<style>
#map {
       width: 800px;
       height: 500px;
       border: 2px solid black;
     }
</style>
    
<script>

$(document).bind('cbox_complete', function() {
       
       var search = JSON.parse("{{ search }}")
       if (document.getElementById("map").childNodes.length == 0) {
              var map = new OpenLayers.Map('map');
              map.addLayer( new OpenLayers.Layer.OSM() );
              var projFrom = new OpenLayers.Projection("EPSG:4326");
              var projTo = new OpenLayers.Projection("EPSG:900913");
              var center = new OpenLayers.LonLat(2,48);
              var cproj = center.transform(projFrom, projTo);
              map.setCenter(cproj, 6);
              var size = new OpenLayers.Size(21,25);
              var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
              var icon = new OpenLayers.Icon('http://openlayers.org/api/img/marker.png', size, offset);
              
              for (i=0; i<search.length; i++) {
                     ent_id = search[i]
                     $.ajax({
                            url: "{% url 'crm_get_addr' %}?term=" + ent_id + "&type=e",
                            success: function(data) {
                                   if (data.lat && data.lon) {
                                          lat = data.lat;
                                          lon = data.lon;
                                          name = data.name;
                                          var markers = new OpenLayers.Layer.Markers( "Markers" );
                                          var mcenter = new OpenLayers.LonLat(lon,lat);
                                          var mproj = mcenter.transform(projFrom, projTo);
                                          markers.addMarker(new OpenLayers.Marker(mproj,icon.clone()));
                                          map.addLayer(markers);
                                   }
                                   else if (data.address) {
                                          var address = data.address
                                          address = address + ", " + data.city;
                                          latitude = data.latitude;
                                          longitude = data.longitude;
                                          
                                          address = address.split(" ").join("+");
                                          
                                          $.ajax({
                                                 async:false,
                                                 url: "http://nominatim.openstreetmap.org/search?q="+address+"&format=jsonv2",
                                                 success: function(data) {       
                                                        if (data[0] != null) {
                                                               lat = data[0].lat;
                                                               lon = data[0].lon;
                                                               // Ajout d'un calque en utilisant le rendu par dÃ©faut
                                                               var markers = new OpenLayers.Layer.Markers( "Markers" );
                                                               var center = new OpenLayers.LonLat(lon,lat);
                                                               var proj = center.transform(projFrom, projTo);
                                                               var size = new OpenLayers.Size(21,25);
                                                               var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                                                               var icon = new OpenLayers.Icon('http://openlayers.org/api/img/marker.png', size, offset);
                                                               markers.addMarker(new OpenLayers.Marker(proj,icon));
                                                               map.addLayer(markers)                                                               
                                                               $.ajax({
                                                                      url: "{% url 'crm_put_coords' %}?ent="+ ent_id +"&lat="+lat+"&lon="+lon+"&type=e",
                                                                      success: function(data) {
              
                                                                      }
                                                               })
                                                               
                                                        }
                                                 }
                                          });
                                   }  
                            }
                     });    
              }
       }
})

       </script>
</head>

<body>
       <span class="glyphicon glyphicon-warning-sign" id='warning' style="color:transparent"></span><strong><span id="msg"></span></strong>
       <div id="map"></div>

</body>
</html>